# SPDX-License-Identifier: GPL-2.0-only OR BSD-2-Clause
%YAML 1.2
---
$id: http://devicetree.org/schemas/mfd/rohm,bd71851-pmic.yaml#
$schema: http://devicetree.org/meta-schemas/core.yaml#

title: ROHM BD71851 Power Management Integrated Circuit

maintainers:
  - Matti Vaittinen <mazziesaccount@gmail.com>

description: |
  BD71815GW is a single-chip power management IC for battery-powered
  portable devices. It integrates 8 buck converters, 4 LDOs and a current
  sense amplifier with ADC. Also included is a Real Time Clock (RTC) and a
  32.768 kHz clock gate. Dependeing on the OTP configuration the BD71851
  may also have interrupt controller and GPIOs.

properties:
  compatible:
    const: rohm,bd71851

  reg:
    description:
    maxItems: 1

  interrupts:
    maxItems: 1

  interrupt-controller: true
    description:
      The GPIO1, GPIO2, FAULT_B and EXTEN_OUT pins may be configured to
      interrupt pins OTP.

  "#interrupt-cells":
    const: 1
    description:
      The IRQ number. Only TODO: type is supported.

  gpio-controller: true

  "#gpio-cells":
    const: 2
    description:
      The GPIO1, GPIO2, FAULT_B and EXTEN_OUT pins may be configured to
      GPIO pins by OTP. If so, the first cell is the pin number and the second
      cell is used to specify flags. TODO: See if we really have something to
      configure with the flags.

  clocks:
    maxItems: 1

  "#clock-cells":
    const: 0

  clock-output-names:
    const: bd71851-32k-out

  rohm,clkout-open-drain:
    description: clk32kout mode. Set to 1 for "open-drain" or 0 for "cmos".
    $ref: /schemas/types.yaml#/definitions/uint32
    minimum: 0
    maximum: 1

# TODO: Should we create a separate ADC driver and more generic ADC + resistor
# based CoulombCounter driver?
#  rohm,charger-sense-resistor-ohms:
#    minimum: 10000000
#    maximum: 50000000
#    description: |
#      BD71827 and BD71828 have SAR ADC for measuring charging currents.
#      External sense resistor (RSENSE in data sheet) should be used. If
#      something other but 30MOhm resistor is used the resistance value
#      should be given here in Ohms.
#    default: 30000000

  regulators:
    $ref: /schemas/regulator/rohm,bd71851-regulator.yaml
    description:
      List of child nodes that specify the regulators.

# TODO: See if the GPIO pin-config is to be handled with some other property
# Do we need more options than GPIO/No-GPIO?
#  gpio-reserved-ranges:
#    description: |
#      Usage of BD71851 GPIO pins can be changed via OTP. This property can be
#      used to mark the pins which should not be configured for GPIO. Please see
#      the ../gpio/gpio.txt for more information.

required:
  - compatible
  - reg
  - interrupts
  - clocks
  - "#clock-cells"
  - regulators

additionalProperties: false

#TODO: Update to right example
examples:
  - |
    #include <dt-bindings/interrupt-controller/irq.h>
    #include <dt-bindings/leds/common.h>
    i2c {
        #address-cells = <1>;
        #size-cells = <0>;
        pmic: pmic@4b {
            compatible = "rohm,bd71815";
            reg = <0x4b>;

            interrupt-parent = <&gpio1>;
            interrupts = <29 IRQ_TYPE_LEVEL_LOW>;

            clocks = <&osc 0>;
            #clock-cells = <0>;
            clock-output-names = "bd71815-32k-out";

            gpio-controller;
            #gpio-cells = <2>;

            rohm,charger-sense-resistor-ohms = <10000000>;

            regulators {
                buck1: buck1 {
                    regulator-name = "buck1";
                    regulator-min-microvolt = <800000>;
                    regulator-max-microvolt = <2000000>;
                    regulator-always-on;
                    regulator-ramp-delay = <1250>;
                    rohm,dvs-run-voltage = <1150000>;
                    rohm,dvs-suspend-voltage = <950000>;
                };
                buck2: buck2 {
                    regulator-name = "buck2";
                    regulator-min-microvolt = <800000>;
                    regulator-max-microvolt = <2000000>;
                    regulator-always-on;
                    regulator-ramp-delay = <1250>;
                    rohm,dvs-run-voltage = <1150000>;
                    rohm,dvs-suspend-voltage = <950000>;
                };
                buck3: buck3 {
                    regulator-name = "buck3";
                    regulator-min-microvolt = <1200000>;
                    regulator-max-microvolt = <2700000>;
                    regulator-always-on;
                };
                buck4: buck4 {
                    regulator-name = "buck4";
                    regulator-min-microvolt = <1100000>;
                    regulator-max-microvolt = <1850000>;
                    regulator-always-on;
                };
                buck5: buck5 {
                    regulator-name = "buck5";
                    regulator-min-microvolt = <1800000>;
                    regulator-max-microvolt = <3300000>;
                    regulator-always-on;
                };
                ldo1: ldo1 {
                    regulator-name = "ldo1";
                    regulator-min-microvolt = <800000>;
                    regulator-max-microvolt = <3300000>;
                    regulator-always-on;
                };
                ldo2: ldo2 {
                    regulator-name = "ldo2";
                    regulator-min-microvolt = <800000>;
                    regulator-max-microvolt = <3300000>;
                    regulator-always-on;
                };
                ldo3: ldo3 {
                    regulator-name = "ldo3";
                    regulator-min-microvolt = <800000>;
                    regulator-max-microvolt = <3300000>;
                    regulator-always-on;
                };
                ldo4: ldo4 {
                    regulator-name = "ldo4";
                    regulator-min-microvolt = <800000>;
                    regulator-max-microvolt = <3300000>;
                    regulator-always-on;
                };
                ldo5: ldo5 {
                    regulator-name = "ldo5";
                    regulator-min-microvolt = <800000>;
                    regulator-max-microvolt = <3300000>;
                    regulator-always-on;
                };
                ldo6: ldodvref {
                    regulator-name = "ldodvref";
                    regulator-always-on;
                };
                ldo7: ldolpsr {
                    regulator-name = "ldolpsr";
                    regulator-always-on;
                };

                boost: wled {
                    regulator-name = "wled";
                    regulator-min-microamp = <10>;
                    regulator-max-microamp = <25000>;
                };
            };
        };
    };
